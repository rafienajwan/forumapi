name: Continuous Deployment

on: 
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: SSH and deploy app
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          echo "ğŸ” Checking environment..."
          export NVM_DIR=~/.nvm
          source ~/.nvm/nvm.sh

          which node
          which npm
          which pm2

          node -v
          npm -v
          pm2 -v

          echo "ğŸ“¦ Pulling latest code..."
          cd ~/forumapi
          git pull origin main

          echo "ğŸ“¦ Installing dependencies..."
          npm install

          echo "ğŸ”„ Running database migrations..."
          npm run migrate up

          echo "ğŸš€ Restarting app with PM2..."
          pm2 restart forumapi || pm2 start ecosystem.config.js --name forumapi
